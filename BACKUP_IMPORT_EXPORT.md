# 备份导入导出功能设计文档

## 功能概述

本系统实现了完整的备份导入导出功能，确保数据的安全性和可恢复性。导入备份的处理逻辑与导出备份的逻辑完全对称，保证了数据格式、结构校验和恢复机制的一致性。

## 导出备份功能

### 文件位置
- API: `admin/api/backup.php`

### 导出逻辑
1. **文件收集**: 从 `data/` 目录收集以下文件:
   - `config.json` - 网站配置
   - `profile.json` - 个人信息
   - `sites.json` - 旗下站点
   - `friends.json` - 友情链接

2. **备份结构**:
   ```json
   {
     "version": "1.0.0",
     "timestamp": "2026-01-14T10:30:00+08:00",
     "files": {
       "config": { ... },
       "profile": { ... },
       "sites": { ... },
       "friends": { ... }
     }
   }
   ```

3. **命名格式**: `full_backup_YYYYmmdd_HHiiss.json`

4. **备份保留策略**: 自动清理，只保留最近5个备份文件

5. **编码格式**: `JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE`

## 导入备份功能

### 文件位置
- API: `admin/api/import.php`

### 导入逻辑（完全对称设计）

#### 1. 文件验证（导出的逆操作）
- **扩展名验证**: 必须是 `.json` 格式（与导出格式一致）
- **文件大小限制**: 最大 50MB
- **文件名验证**: 推荐使用标准备份文件名格式

#### 2. 数据结构验证（完全匹配导出结构）
```php
// 验证必需字段
- version: 版本号，格式必须是 x.x.x
- timestamp: ISO 8601 时间戳
- files: 包含备份数据的对象

// 验证文件类型
允许的文件类型: config, profile, sites, friends
```

#### 3. 数据完整性校验
- JSON 解析有效性检查
- 每个 fileData 必须是数组类型
- 验证备份时间戳的有效性

#### 4. 安全恢复机制（与导出对称）
- **导入前自动备份**: 在覆盖数据前，先将当前数据备份到 `backups/` 目录
  - 备份命名: `{type}_import_backup_YYYYmmdd_HHiiss.json`
- **逐文件验证**: 只导入验证通过的文件
- **错误隔离**: 某个文件导入失败不影响其他文件

#### 5. 数据恢复（与导出完全对称）
```php
// 写入格式与导出完全一致
json_encode($fileData, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE)
```

#### 6. 响应结构
```json
{
  "success": true,
  "message": "数据导入成功",
  "importedFiles": ["config", "profile", "sites", "friends"],
  "backupTimestamp": "2026-01-14T10:30:00+08:00",
  "backupVersion": "1.0.0",
  "warnings": []  // 可选的警告信息
}
```

## 对称性保证

### 格式对称
| 导出 | 导入 | 说明 |
|------|------|------|
| JSON 格式 | JSON 格式 | 文件类型完全一致 |
| `JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE` | 同样的编码 | 保留可读性和中文字符 |
| `full_backup_*.json` | 只接受 `.json` | 文件扩展名一致 |

### 结构对称
| 导出 | 导入 | 说明 |
|------|------|------|
| version 字段 | 验证 version | 版本号格式检查 |
| timestamp 字段 | 验证 timestamp | ISO 8601 格式验证 |
| files 数组 | 验证 files | 数据结构一致性 |
| 4种数据文件 | 只接受这4种文件 | 文件类型限制 |

### 流程对称
| 导出 | 导入 | 说明 |
|------|------|------|
| 读取 JSON 文件 | 写入 JSON 文件 | 读写操作对称 |
| `json_decode()` | `json_encode()` | 编解码对称 |
| `file_get_contents()` | `file_put_contents()` | 文件操作对称 |
| 备份到 backups/ | 从 backups/ 恢复 | 存储位置对称 |

### 安全对称
| 导出 | 导入 | 说明 |
|------|------|------|
| 需要 | 需要 | 认证检查（auth.php） |
| 保留最近5个 | 导入前自动备份 | 数据保护策略对称 |
| 只读取指定文件 | 只恢复验证通过文件 | 操作范围对称 |

## 前端功能

### 备份操作
- **位置**: 版本管理面板
- **触发**: `backupData()` 函数
- **流程**:
  1. 确认对话框
  2. 显示加载提示
  3. 调用 API
  4. 显示结果提示

### 导入操作
- **位置**: 版本管理面板
- **触发**: `importData()` 函数
- **流程**:
  1. 文件选择器
  2. 文件验证（扩展名、文件名格式）
  3. 确认对话框
  4. 显示加载提示
  5. 上传文件到 API
  6. 显示详细结果（导入文件、版本、时间等）
  7. 自动刷新页面

### 备份列表
- **位置**: 版本管理面板
- **API**: `admin/api/backups.php`
- **功能**:
  - 显示所有备份文件
  - 显示文件大小、时间、版本
  - 显示包含的数据类型
  - 下载备份文件

## 错误处理

### 导出错误
- JSON 编码失败
- 文件写入失败
- 目录创建失败

### 导入错误
- 文件上传失败
- 扩展名不正确
- JSON 解析失败
- 数据结构不完整
- 版本号格式错误
- 时间戳格式错误
- 文件写入失败

所有错误都有详细的错误信息返回给前端用户。

## 数据一致性

### 导出数据完整性
- 只导出存在的数据文件
- 空对象也会被导出（结构完整性）

### 导入数据完整性
- 验证每个文件的数据结构
- 只导入验证通过的数据
- 提供详细的导入报告
- 保留原始备份作为回滚保障

## 使用示例

### 导出备份
1. 登录后台管理系统
2. 进入"版本管理"页面
3. 点击"备份数据"按钮
4. 确认备份操作
5. 等待备份完成
6. 备份文件保存在 `data/backups/` 目录

### 导入备份
1. 登录后台管理系统
2. 进入"版本管理"页面
3. 点击"导入备份"按钮
4. 选择备份文件（.json格式）
5. 确认导入操作
6. 等待导入完成
7. 系统自动刷新显示恢复的数据

### 下载备份
1. 进入"版本管理"页面
2. 在"备份历史"中查看所有备份
3. 点击"下载"按钮下载备份文件
4. 可以在其他地方恢复或存档

## 技术实现要点

### PHP 后端
- 使用 `file_get_contents()` / `file_put_contents()` 进行文件操作
- 使用 `json_decode()` / `json_encode()` 处理 JSON 数据
- 使用 `glob()` 获取备份文件列表
- 使用 `usort()` 排序文件
- 使用 `copy()` 创建备份副本

### JavaScript 前端
- 使用 `fetch()` 进行 API 调用
- 使用 `FormData` 上传文件
- 使用 `FileReader` 处理文件
- 使用 `createElement()` 创建下载链接
- 使用 `setTimeout()` 延迟刷新

### 安全性
- 所有 API 都需要认证 (`auth.php`)
- 文件类型和大小严格验证
- 数据结构完整性检查
- 导入前自动备份原始数据
- 错误隔离防止部分失败影响整体

## 测试建议

1. **导出测试**:
   - 创建完整数据备份
   - 验证备份文件格式正确
   - 检查所有数据字段完整性
   - 验证 JSON 格式可读性

2. **导入测试**:
   - 使用刚导出的备份进行导入
   - 验证数据完全恢复
   - 检查备份文件是否生成
   - 测试部分文件导入（手动修改备份）

3. **异常测试**:
   - 导入非 JSON 文件
   - 导入损坏的 JSON 文件
   - 导入结构不完整的文件
   - 导入超大文件（>50MB）

4. **兼容性测试**:
   - 测试不同版本的备份文件
   - 测试包含中文字符的数据
   - 测试特殊字符和转义字符
   - 测试空数据文件

## 维护建议

1. **备份定期清理**: 系统自动保留最近5个备份，可定期手动清理旧备份
2. **备份存档**: 重要备份建议下载存档到外部存储
3. **版本升级**: 升级前务必创建完整备份
4. **灾难恢复**: 保留多个时间点的备份以应对不同恢复需求
5. **监控日志**: 关注备份和导入操作日志，及时发现异常
